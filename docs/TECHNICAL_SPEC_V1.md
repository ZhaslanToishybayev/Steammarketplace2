# 📘 ТЕХНИЧЕСКАЯ ДОКУМЕНТАЦИЯ: Steam Trading Platform - Rate Limiting & Bot Inventory Sync

**Версия:** 1.0  
**Дата создания:** 25 января 2026  
**Статус:** В реализации (In Progress)  
**Автор:** OpenCode AI Assistant  
**Reviewer:** Zhaslan (Product Owner)

---

## 📑 СОДЕРЖАНИЕ

1. [Обзор проблемы](#1-обзор-проблемы)
2. [Цели и требования](#2-цели-и-требования)
3. [Архитектура решения](#3-архитектура-решения)
4. [Детальная спецификация компонентов](#4-детальная-спецификация-компонентов)
5. [Последовательность работы (Flow)](#5-последовательность-работы-flow)
6. [API Спецификации](#6-api-спецификации)
7. [Структура данных](#7-структура-данных)
8. [Критерии приемки](#8-критерии-приемки)
9. [Метрики успеха](#9-метрики-успеха)
10. [Тестовые сценарии](#10-тестовые-сценарии)
11. [Риски и ограничения](#11-риски-и-ограничения)
12. [План отката (Rollback)](#12-план-отката-rollback)
13. [Журнал реализации (Progress Log)](#13-журнал-реализации-progress-log)

---

## 1. ОБЗОР ПРОБЛЕМЫ

### 1.1 Текущее состояние (AS-IS)

**Проблема №1: Steam Bot не может авторизоваться**
- При старте Docker контейнера Worker процесс пытается залогинить Steam бота
- Библиотека `steam-user` делает множество синхронных запросов к Steam API без задержек
- Steam блокирует IP адрес (HTTP 429 - Too Many Requests)
- **Результат:** Бот офлайн, инвентарь не загружается в БД

**Проблема №2: Маркетплейс показывает фейковые данные**
- База данных `listings` пустая (т.к. бот не загрузил инвентарь)
- Frontend fallback вызывает `/api/analytics/steam-market-items`
- Этот endpoint делает 48 запросов к Steam Market API
- **Результат:** Повторный бан 429, пользователи видят моковые предметы которые нельзя купить

**Проблема №3: Cascade failure**
- Один 429 бан блокирует ВСЕ запросы с этого IP (включая inventory sync пользователей)
- Пользователи не могут загрузить свой инвентарь на странице `/sell`
- **Результат:** Сайт полностью нефункционален

### 1.2 Желаемое состояние (TO-BE)

**Цель:** Стабильная работа торговой платформы с автоматической синхронизацией инвентаря бота

**Ключевые требования:**
1. ✅ Бот успешно логинится при старте (даже при высокой нагрузке)
2. ✅ Инвентарь бота автоматически загружается в БД
3. ✅ Маркетплейс показывает ТОЛЬКО реальные предметы от бота
4. ✅ Нет 429 ошибок от Steam API
5. ✅ Пользователи могут покупать предметы из инвентаря бота
6. ✅ Система работает стабильно 24/7

---

## 2. ЦЕЛИ И ТРЕБОВАНИЯ

### 2.1 Бизнес-требования (Business Requirements)

| ID | Требование | Приоритет | Обоснование |
|----|-----------|-----------|-------------|
| BR-1 | Маркетплейс должен показывать реальные предметы от бота | **КРИТИЧНО** | Это core функция платформы |
| BR-2 | Пользователи должны мочь купить любой предмет из списка | **КРИТИЧНО** | Иначе нет доверия к платформе |
| BR-3 | Купленный предмет должен исчезнуть из списка в течение 30 секунд | **ВЫСОКИЙ** | Избежать двойных продаж |
| BR-4 | Система должна работать без downtime | **ВЫСОКИЙ** | Коммерческая платформа |
| BR-5 | Не должно быть фейковых/недоступных предметов | **КРИТИЧНО** | Доверие пользователей |

### 2.2 Технические требования (Technical Requirements)

| ID | Требование | Метрика | Acceptance Criteria |
|----|-----------|---------|---------------------|
| TR-1 | Steam Bot login success rate | ≥ 95% | 19 из 20 запусков успешны |
| TR-2 | Время синхронизации инвентаря | ≤ 60 секунд | От старта до появления в БД |
| TR-3 | Steam API 429 error rate | = 0% | Нет 429 ошибок в логах за 24 часа |
| TR-4 | Marketplace data freshness | ≤ 30 секунд | Купили → исчез за 30 сек |
| TR-5 | Inventory sync retry mechanism | 3 попытки с backoff | При 429 → retry через 1, 2, 4 минуты |
| TR-6 | Redis-based rate limiter accuracy | 100% | Никогда не превышает 20 req/min |
| TR-7 | Логирование всех Steam API вызовов | 100% coverage | Каждый запрос логируется |

### 2.3 Нефункциональные требования (Non-Functional Requirements)

**Производительность:**
- Маркетплейс должен загружаться за ≤ 2 секунды
- API `/api/escrow/listings` должен отвечать за ≤ 200ms

**Надежность:**
- Система должна автоматически восстанавливаться после 429 бана
- При падении бота — автоматический перезапуск через 5 минут

**Масштабируемость:**
- Rate Limiter должен работать в multi-instance окружении (через Redis)

**Безопасность:**
- Steam bot credentials хранятся в переменных окружения
- Никакие секреты не логируются

---

## 3. АРХИТЕКТУРА РЕШЕНИЯ

### 3.1 Компоненты системы

```
┌─────────────────────────────────────────────────────────────────┐
│                        DOCKER COMPOSE                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐     │
│  │  Frontend   │──────│   Nginx     │──────│   Backend   │     │
│  │  (Next.js)  │      │  (Gateway)  │      │  (Node.js)  │     │
│  └─────────────┘      └─────────────┘      └──────┬──────┘     │
│                                                     │            │
│  ┌──────────────────────────────────────────────┐  │            │
│  │              Worker Process                   │  │            │
│  │  ┌────────────────────────────────────────┐  │  │            │
│  │  │  Steam Bot Manager                     │  │  │            │
│  │  │  ┌──────────────┐   ┌──────────────┐  │  │  │            │
│  │  │  │ Rate Limiter │   │ Retry Logic  │  │  │  │            │
│  │  │  └──────┬───────┘   └──────┬───────┘  │  │  │            │
│  │  │         └──────────┬────────┘          │  │  │            │
│  │  │                    │                   │  │  │            │
│  │  │         ┌──────────▼───────────┐       │  │  │            │
│  │  │         │   Steam Bot Client   │       │  │  │            │
│  │  │         │   (steam-user lib)   │       │  │  │            │
│  │  │         └──────────┬───────────┘       │  │  │            │
│  │  │                    │                   │  │  │            │
│  │  │         ┌──────────▼───────────┐       │  │  │            │
│  │  │         │ Inventory Sync Job   │       │  │  │            │
│  │  │         └──────────┬───────────┘       │  │  │            │
│  │  └────────────────────┼───────────────────┘  │  │            │
│  └───────────────────────┼──────────────────────┘  │            │
│                          │                          │            │
│  ┌───────────────────────▼──────────────────────┐  │            │
│  │            PostgreSQL Database                │◄─┘            │
│  │  ┌────────────────────────────────────────┐  │               │
│  │  │  listings (bot inventory items)        │  │               │
│  │  │  escrow_trades (purchase records)      │  │               │
│  │  └────────────────────────────────────────┘  │               │
│  └───────────────────────────────────────────────┘               │
│                                                                   │
│  ┌───────────────────────────────────────────────┐               │
│  │              Redis Cache                       │               │
│  │  ┌────────────────────────────────────────┐   │               │
│  │  │  steam:ratelimit:*  (rate limiter)    │   │               │
│  │  │  analytics:*        (cache)           │   │               │
│  │  │  sess:*             (sessions)        │   │               │
│  │  └────────────────────────────────────────┘   │               │
│  └───────────────────────────────────────────────┘               │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
                  ┌──────────────────┐
                  │   Steam API      │
                  │  (External)      │
                  └──────────────────┘
```

### 3.2 Ключевые изменения

| Компонент | Изменение | Причина |
|-----------|-----------|---------|
| **Bot Login** | Добавлен Retry + Exponential Backoff | Избежать 429 при старте |
| **Bot Manager** | Задержка 10 секунд между ботами | Не превышать rate limit |
| **Rate Limiter** | Централизованный через Redis | Работает в multi-instance |
| **Inventory Sync** | Автозапуск после успешного логина | Заполнить БД автоматически |
| **Frontend** | Убран fallback на Steam Market | Показывать только реальные данные |
| **Analytics** | Кэш на 24 часа | Снизить нагрузку |

---

## 4. ДЕТАЛЬНАЯ СПЕЦИФИКАЦИЯ КОМПОНЕНТОВ

### 4.1 Steam Rate Limiter

**Местоположение:** `apps/backend/src/utils/steam-rate-limiter.js` (новый файл)

**Назначение:** Глобальный контроллер частоты запросов к Steam API

**Технические характеристики:**

| Параметр | Значение | Обоснование |
|----------|----------|-------------|
| Максимум запросов | 20 req/min | Консервативный лимит (Steam = ~30) |
| Окно времени | 60000ms (1 минута) | Стандартное окно для rate limiting |
| Хранилище счетчика | Redis | Общий для всех инстансов |
| Ключ Redis | `steam:ratelimit:{timestamp}` | Уникальный на каждую минуту |
| TTL ключа | 120 секунд | 2 минуты (для надежности) |
| Поведение при превышении | Wait & Retry | Блокируется до следующего окна |

**Интерфейс (API):**

```typescript
class SteamRateLimiter {
  /**
   * Ждет свободного слота и выполняет функцию
   * @param asyncFn - Асинхронная функция для выполнения
   * @returns Promise с результатом функции
   * @throws Error если Redis недоступен
   */
  async execute<T>(asyncFn: () => Promise<T>): Promise<T>
  
  /**
   * Проверяет, можно ли сделать запрос (не блокирует)
   * @returns boolean - true если лимит не превышен
   */
  async canMakeRequest(): Promise<boolean>
  
  /**
   * Получить текущее количество запросов в окне
   * @returns number - количество запросов за последнюю минуту
   */
  async getCurrentCount(): Promise<number>
}
```

**Алгоритм работы:**

```
1. Получить текущее время (timestamp)
2. Вычислить ключ окна: floor(timestamp / 60000)
3. INCR ключ в Redis
4. Установить TTL = 120 сек (если ключ новый)
5. Если значение > 20:
   - Вычислить время ожидания до следующего окна
   - Sleep(waitTime)
   - Goto step 1 (retry)
6. Выполнить asyncFn()
7. Вернуть результат
```

### 4.2 Bot Login with Retry

**Местоположение:** `apps/backend/src/config/bots.config.js` (изменение существующей функции)

**Назначение:** Надежный логин бота с retry механизмом

**Технические характеристики:**

| Параметр | Значение | Обоснование |
|----------|----------|-------------|
| Максимум попыток | 3 | Баланс между надежностью и временем ожидания |
| Backoff стратегия | Exponential (1min, 2min, 4min) | Стандартный подход |
| Задержка между ботами | 10000ms (10 сек) | Избежать одновременных логинов |
| Timeout одной попытки | 30000ms | Steam может отвечать медленно |
| Обработка 429 | Специальный retry | Другие ошибки → fail fast |

### 4.3 Inventory Sync Job

**Местоположение:** `apps/backend/src/worker.js` (изменение существующего кода)

**Назначение:** Автоматическая синхронизация инвентаря бота с БД

**Технические характеристики:**

| Параметр | Значение | Обоснование |
|----------|----------|-------------|
| Триггер | После успешного логина бота | Зависимость от бота |
| Приоритет задачи | HIGH | Критичная операция |
| Timeout | 120000ms (2 минуты) | Инвентарь может быть большим |
| Retry при ошибке | 2 попытки | Сетевые сбои возможны |
| Частота повторной синхронизации | Каждые 6 часов | Обновление цен и новых предметов |

### 4.4 Frontend Fallback Removal

**Местоположение:** `apps/frontend/src/app/(main)/marketplace/page.tsx`

**Назначение:** Убрать показ моковых данных из Steam Market API

**Изменения:**
- Удалить вызов `/api/analytics/steam-market-items`
- Если листингов нет, показывать UI "Синхронизация..."

### 4.5 Analytics Endpoint Caching

**Местоположение:** `apps/backend/src/routes/analytics.js`

**Назначение:** Кэшировать результаты Steam Market API на 24 часа

**Изменения:**
- Использовать Redis для кэширования
- TTL 24 часа
- Запросы через Rate Limiter

---

## 5. ПОСЛЕДОВАТЕЛЬНОСТЬ РАБОТЫ (FLOW)

### 5.1 Стартовая последовательность (Happy Path)

```
T=0:00:00  [Docker] docker compose up -d
           │
T=0:00:05  [Worker] Процесс запущен
           ├─ Подключение к Redis... ✅
           ├─ Подключение к PostgreSQL... ✅
           └─ Запуск миграций... ✅
           │
T=0:00:10  [Worker] Инициализация ботов
           ├─ Бот "Sgovt1": Попытка 1/3
           ├─ Ожидание 2FA code generation...
           └─ Steam API: logon request
           │
T=0:00:15  [Steam API] Ответ: Logged in successfully
           │
T=0:00:16  [Worker] ✅ Бот "Sgovt1" залогинен
           ├─ Добавление job 'system-sync-inventory'
           └─ Telegram: "✅ Bot started successfully"
           │
T=0:00:20  [Bull Queue] Обработка job 'system-sync-inventory'
           ├─ Получение бота...
           ├─ Запрос инвентаря через Rate Limiter
           └─ Steam API: getInventory(730, 2)
           │
T=0:00:45  [Steam API] Ответ: 150 items
           │
T=0:00:46  [Worker] Обработка предметов
           ├─ Item 1: AWP Asiimov
           │  ├─ Запрос цены через Rate Limiter
           │  ├─ Steam API: priceoverview
           │  └─ INSERT INTO listings
           ├─ ...
           └─ Item 150: ...
           │
T=0:02:30  [Worker] ✅ Синхронизация завершена
           ├─ Synced 150 items to database
           ├─ Redis: DEL marketplace:listings:cache
           └─ Telegram: "✅ Inventory sync: 150 items"
           │
T=0:02:35  [User] Открывает http://localhost:3000/marketplace
           │
T=0:02:36  [Frontend SSR] GET /api/escrow/listings?limit=50
           │
T=0:02:37  [Backend] Запрос к PostgreSQL
           ├─ SELECT * FROM listings WHERE status='active' LIMIT 50
           └─ Результат: 50 items
           │
T=0:02:38  [Frontend] Рендеринг маркетплейса с 50 предметами ✅
```

---

## 6. API СПЕЦИФИКАЦИИ

### 6.1 GET /api/escrow/listings

**Назначение:** Получить список активных предметов от бота

**Endpoint:** `GET /api/escrow/listings`

**Query Parameters:**
- `limit` (number, default 50)
- `offset` (number, default 0)
- `sort` (string, default 'created_at')
- `order` (string, default 'DESC')

**Response (200 OK):**
```json
{
  "success": true,
  "data": [
    {
      "id": 123,
      "seller_steam_id": "76561198000000001",
      "asset_id": "12345678901",
      "item_name": "AWP | Asiimov (Field-Tested)",
      "item_market_hash_name": "AWP | Asiimov (Field-Tested)",
      "item_icon_url": "https://community.steamstatic.com/economy/image/...",
      "price": "85.43",
      "status": "active",
      "created_at": "2026-01-25T20:30:00.000Z"
    }
  ],
  "pagination": { "total": 150, "limit": 50, "offset": 0, "hasMore": true }
}
```

### 6.2 GET /api/analytics/steam-market-items

**Назначение:** Получить популярные скины из Steam Market (для аналитики)

**Endpoint:** `GET /api/analytics/steam-market-items`

**Response (200 OK):**
```json
{
  "success": true,
  "data": [...],
  "source": "redis_cache",
  "count": 24,
  "fetched_at": "2026-01-25T12:00:00.000Z"
}
```

---

## 7. СТРУКТУРА ДАННЫХ

### 7.1 База данных (PostgreSQL)

**Таблица: listings**

| Колонка | Тип | Nullable | Default | Индекс | Описание |
|---------|-----|----------|---------|--------|----------|
| id | SERIAL | NO | AUTO | PRIMARY KEY | Уникальный ID |
| seller_steam_id | VARCHAR(20) | NO | - | INDEX | SteamID продавца (бота) |
| asset_id | VARCHAR(20) | NO | - | UNIQUE | AssetID в инвентаре Steam |
| item_name | VARCHAR(255) | NO | - | - | Название предмета |
| item_market_hash_name | VARCHAR(255) | NO | - | INDEX | Хэш для поиска |
| item_icon_url | TEXT | YES | - | - | URL иконки |
| price | DECIMAL(10,2) | NO | - | INDEX | Цена в USD |
| status | VARCHAR(20) | NO | 'active' | INDEX | active, pending_trade, sold, cancelled |
| created_at | TIMESTAMP | NO | NOW() | INDEX | Дата создания |
| updated_at | TIMESTAMP | NO | NOW() | - | Дата обновления |

### 7.2 Redis (Кэш и Rate Limiter)

| Ключ | TTL | Назначение |
|------|-----|------------|
| `steam:ratelimit:{timestamp}` | 120s | Счетчик запросов в минуту |
| `analytics:steam_market_items:v1` | 24h | Кэш Steam Market данных |
| `marketplace:listings:cache` | 30s | Кэш списка активных listings |

---

## 8. КРИТЕРИИ ПРИЕМКИ

### 8.1 Обязательные критерии (Must Have)

| ID | Критерий | Метод проверки | Результат |
|----|----------|----------------|-----------|
| AC-1 | Бот успешно логинится при старте | Проверить логи: "✅ Logged in successfully" | PASS/FAIL |
| AC-2 | Инвентарь синхронизируется в БД | `SELECT COUNT(*) FROM listings WHERE status='active'` > 0 | PASS/FAIL |
| AC-3 | Маркетплейс показывает реальные предметы | Открыть /marketplace → увидеть предметы от бота | PASS/FAIL |
| AC-4 | Нет 429 ошибок в логах | `grep "429" logs/backend.log` → пусто | PASS/FAIL |
| AC-5 | Можно купить предмет | Нажать "Купить" → создается trade offer | PASS/FAIL |
| AC-6 | Купленный предмет исчезает | Проверить `status='pending_trade'` в БД | PASS/FAIL |

---

## 9. МЕТРИКИ УСПЕХА

- **Bot login success rate:** ≥ 95%
- **Steam API 429 errors:** 0 в день
- **Listings in DB:** 100-200 активных
- **Marketplace load time:** ≤ 2 seconds
- **Inventory sync time:** ≤ 60 seconds

---

## 10. ТЕСТОВЫЕ СЦЕНАРИИ

### 10.1 Unit Tests
- `SteamRateLimiter`: должен позволять 20 запросов в минуту, блокировать 21-й.
- `SteamRateLimiter`: должен сбрасывать счетчик каждую минуту.

### 10.2 Integration Tests
- `Bot Login`: должен успешно залогинить бота с retry.
- `Bot Login`: должен retry при 429 ошибке.

### 10.3 E2E Tests
- `Marketplace`: должен показать предметы от бота на /marketplace.
- `Marketplace`: должен купить предмет и удалить из списка.

---

## 11. РИСКИ И ОГРАНИЧЕНИЯ

| Риск | Митигация |
|------|-----------|
| Steam меняет API без уведомления | Мониторинг ошибок, fallback логика |
| Redis падает → Rate Limiter не работает | Health checks, auto-restart |
| Бот банится Steam Guard | Использовать проверенные аккаунты |
| PostgreSQL медленно отвечает | Connection pooling, индексы |
| Race condition при покупке | Row-level locks (FOR UPDATE) |

---

## 12. ПЛАН ОТКАТА (ROLLBACK)

**Процедура отката:**
1. `docker compose down`
2. `git checkout <commit-hash>`
3. `docker compose build --no-cache`
4. `docker compose up -d`

---

## 13. ЖУРНАЛ РЕАЛИЗАЦИИ (PROGRESS LOG)

### 25 Января 2026 - Сессия 1
**Статус:** ✅ Реализовано (требует тестирования)

1. **Steam Rate Limiter**
   - [x] Создан `SteamRateLimiter` класс (Redis-based)
   - [x] Настроен лимит 20 req/min
   - [x] Реализована логика ожидания (wait & retry)

2. **Bot Login Improvements**
   - [x] Обновлен `bot-manager.service.js`
   - [x] Добавлен exponential backoff для повторных попыток входа
   - [x] Добавлена задержка между инициализацией ботов

3. **Steam API Service**
   - [x] Интегрирован `SteamRateLimiter` во все вызовы API
   - [x] Добавлена обработка ошибок и логирование

4. **Inventory Sync**
   - [x] Обновлен `worker.js`
   - [x] Реализован автозапуск синхронизации после логина
   - [x] Добавлена обработка предметов и сохранение в БД

5. **Analytics & Caching**
   - [x] Обновлен `analytics.js`
   - [x] Внедрено кэширование Redis (24 часа) для данных рынка
   - [x] Убраны лишние запросы к Steam API

6. **Frontend**
   - [x] Убран fallback на фейковые данные Steam Market
   - [x] UI теперь показывает реальное состояние синхронизации

**Следующие шаги:**
- Запуск и тестирование (Docker Compose up)
- Проверка логов на наличие ошибок
- Верификация работы Rate Limiter

---

**Конец документации.**
